---
import type { HeaderItem } from '../types/headers';

interface Props {
  item: HeaderItem;
}

const { item } = Astro.props;
const defaultButtonId = item.megaMenuContent?.buttons?.[0]?.id ?? 'wraps';
---

<div class="mega-menu-wrapper z-20 flex text-font">
  <div
    class="mega-menu-trigger inline-flex relative items-center text-sm lg:text-base font-medium text-slate-800 py-2 px-4 rounded-full hover:text-primary"
  >
    <button class="menu-toggle group w-full px-4 justify-between flex items-center rounded-md">
      <span class="flex xl:py-1 group-hover:text-primary items-center cursor-pointer dark:text-slate-300">
        {item.name}
      </span>
      <svg
        class="chevron-icon size-5 transition-transform duration-300 text-gray-500 inline-block ml-2 group-hover:text-primary"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z"
          clip-rule="evenodd"
        />
      </svg>
    </button>

    <div
      class="mega-menu-panel fixed top-24 bottom-auto m-auto left-20 right-20 z-30 rounded-md bg-white shadow-lg ring-1 mt-3 container ring-gray-900/5 dark:bg-slate-950 opacity-0 translate-y-1 pointer-events-none transition-all duration-200 ease-out"
    >
      <div class="bg-white shadow-lg rounded-lg border border-slate-200 dark:bg-slate-950 dark:border-slate-800">
        <div class="flex">
          <div class="text-sm w-fit whitespace-nowrap">
            <div class="bg-slate-100 dark:bg-slate-800 h-full w-full py-10 px-6">
              <nav class="flex flex-col space-y-3.5">
                {item.megaMenuContent?.buttons?.map((button) => (
                  <button
                    data-button-id={button.id}
                    class:list={[
                      'tab-button justify-between !bg-transparent inline-flex items-center text-base font-bold',
                      button.id === defaultButtonId
                        ? 'text-orange-500'
                        : 'text-slate-600 hover:text-primary dark:text-slate-400',
                    ]}
                  >
                    {button.name}
                    <svg
                      class="size-5 flex-none text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                ))}
              </nav>
            </div>
          </div>

          <div class="flex-grow">
            <div class="py-10">
              {item.megaMenuContent?.panels?.map((panel) => (
                <div
                  class:list={['tabpanel', panel.id !== defaultButtonId && 'hidden']}
                  data-panel-id={panel.id}
                >
                  <div class="grid grid-cols-4 divide-x divide-slate-200 dark:divide-slate-700">
                    {panel.subPanels.map((subPanel) => (
                      <div class="px-2">
                        <p class="text-base font-bold text-slate-800 dark:text-slate-200 whitespace-pre-line pl-3">
                          {subPanel.title}
                        </p>
                        <ul class="grid space-y-3 mt-4">
                          {subPanel.items.map((menuItem) => (
                            <li>
                              <a
                                class="text-sm font-bold pl-3 text-slate-500 hover:text-primary dark:text-slate-400"
                                href={menuItem.href}
                              >
                                {menuItem.name}
                              </a>
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    const wrappers = document.querySelectorAll('.mega-menu-wrapper');

    wrappers.forEach((wrapper) => {
      const trigger = wrapper.querySelector('.mega-menu-trigger');
      const panel = wrapper.querySelector('.mega-menu-panel');
      const chevron = wrapper.querySelector('.chevron-icon');
      const toggleButton = wrapper.querySelector('.menu-toggle');
      const tabButtons = wrapper.querySelectorAll('.tab-button');
      const tabPanels = wrapper.querySelectorAll('.tabpanel');

      let isOpen = false;
      let closeTimeout: ReturnType<typeof setTimeout> | null = null;

      const openMenu = () => {
        if (closeTimeout) {
          clearTimeout(closeTimeout);
          closeTimeout = null;
        }
        isOpen = true;
        panel?.classList.remove('opacity-0', 'translate-y-1', 'pointer-events-none');
        panel?.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
        chevron?.classList.add('rotate-180');
      };

      const closeMenu = () => {
        closeTimeout = setTimeout(() => {
          isOpen = false;
          panel?.classList.add('opacity-0', 'translate-y-1', 'pointer-events-none');
          panel?.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
          chevron?.classList.remove('rotate-180');
        }, 100);
      };

      trigger?.addEventListener('mouseenter', openMenu);
      trigger?.addEventListener('mouseleave', closeMenu);
      panel?.addEventListener('mouseenter', openMenu);
      panel?.addEventListener('mouseleave', closeMenu);

      toggleButton?.addEventListener('click', () => {
        if (isOpen) {
          isOpen = false;
          panel?.classList.add('opacity-0', 'translate-y-1', 'pointer-events-none');
          panel?.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
          chevron?.classList.remove('rotate-180');
        } else {
          openMenu();
        }
      });

      // Tab functionality
      tabButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const buttonId = button.getAttribute('data-button-id');

          // Update button styles
          tabButtons.forEach((btn) => {
            btn.classList.remove('text-orange-500');
            btn.classList.add('text-slate-600', 'hover:text-primary', 'dark:text-slate-400');
          });
          button.classList.add('text-orange-500');
          button.classList.remove('text-slate-600', 'hover:text-primary', 'dark:text-slate-400');

          // Show/hide panels
          tabPanels.forEach((tabPanel) => {
            const panelId = tabPanel.getAttribute('data-panel-id');
            if (panelId === buttonId) {
              tabPanel.classList.remove('hidden');
            } else {
              tabPanel.classList.add('hidden');
            }
          });
        });
      });
    });
  });
</script>