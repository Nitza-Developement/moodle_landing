---
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import LatestArticle from "../../../components/ui/LatestArticle.astro";
import BlogHero from "../../../components/BlogHero.astro";
import es from "../../../i18n/locales/es.json";

export async function getStaticPaths() {
    const allPosts = await getCollection("blog");
    const uniqueCategories = [
        ...new Set(allPosts.map((post) => post.data.categorySlug)),
    ];

    return uniqueCategories.map((categorySlug) => {
        const categoryName = allPosts.find(
            (p) => p.data.categorySlug === categorySlug,
        )?.data.category;
        return {
            params: { category: categorySlug },
            props: { categoryName },
        };
    });
}

const { category } = Astro.params;
const { categoryName } = Astro.props;
const { blog } = es;

const allPosts = await getCollection("blog");
const filteredPosts = allPosts
    .filter((post) => post.data.categorySlug === category)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const title = `Categoría: ${categoryName} | MetisHost`;
const description = `Artículos sobre ${categoryName} en el blog de MetisHost.`;
---

<Layout title={title} description={description}>
    <BlogHero
        badge={blog.hero.badge}
        title={{
            line1: "Categoría:",
            highlight: categoryName,
        }}
        subtitle={`Explora todos nuestros artículos sobre ${categoryName}.`}
        cta={blog.hero.cta}
    />

    <section class="py-16 bg-bg-light dark:bg-dark-bg-primary">
        <div class="max-w-7xl mx-auto px-6">
            <div class="mb-10">
                <a
                    href="/blog"
                    class="text-primary hover:text-primary-dark transition-colors dark:text-primary-light"
                >
                    ← Volver al blog
                </a>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                {
                    filteredPosts.map((post) => (
                        <LatestArticle
                            image={
                                (typeof post.data.heroImage === "string"
                                    ? post.data.heroImage
                                    : post.data.heroImage?.src) || ""
                            }
                            imageAlt={post.data.title}
                            category={post.data.category}
                            categoryUrl={`/blog/categoria/${post.data.categorySlug}`}
                            title={post.data.title}
                            url={`/blog/${post.id}`}
                            description={post.data.description}
                            pubDate={post.data.pubDate}
                            readingTime={post.data.readingTime}
                        />
                    ))
                }
            </div>
        </div>
    </section>
</Layout>
