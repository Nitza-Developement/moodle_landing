---
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import Reviews from "./Reviews.astro";
import Badge from "./Badge.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const footerContent = t("footer");

interface ReviewContent {
    name: string;
    text: string;
    img: string;
    stars: number;
}
// Fetch reviews at build/request time
const reviews: ReviewContent[] = t("reviews");
---

<div class="p-5 w-full md:w-1/2">
    <Badge text={footerContent.reviews.badge_text} type="Default" />
    <h2
        class="text-3xl font-semibold text-slate-900 max-w-xl mb-4 mt-2 dark:text-white"
        set:html={footerContent.reviews.title}
    />
    <div class="reviews-container">
        <div class="review-wrapper p-5 rounded-md">
            {
                reviews.map((review, index) => (
                    <div
                        class:list={["review-slide", { active: index === 0 }]}
                        data-index={index}
                    >
                        <Reviews review={review} />
                    </div>
                ))
            }
        </div>
        <div class="flex justify-around mb-5 mt-2">
            {
                reviews.map((review, index) => (
                    <button
                        class:list={["tab-button", { active: index === 0 }]}
                        data-tab={index}
                    >
                        <img
                            src={review.img}
                            alt="Tab Image"
                            class="w-12 h-12 rounded-full"
                        />
                    </button>
                ))
            }
        </div>
    </div>
</div>

<script>
    function initReviewCarousel() {
        let activeTab = 0;
        const slides = document.querySelectorAll<HTMLElement>(".review-slide");
        const buttons =
            document.querySelectorAll<HTMLButtonElement>(".tab-button");

        function setActiveTab(index: number) {
            activeTab = index;
            slides.forEach((slide, i) => {
                slide.classList.toggle("active", i === index);
            });
            buttons.forEach((btn, i) => {
                btn.classList.toggle("active", i === index);
            });
        }

        buttons.forEach((button) => {
            button.addEventListener("click", () => {
                const index = Number(button.dataset.tab);
                setActiveTab(index);
            });
        });

        // Auto-rotate every 5 seconds
        setInterval(() => {
            if (slides.length > 0) {
                const nextTab =
                    activeTab < slides.length - 1 ? activeTab + 1 : 0;
                setActiveTab(nextTab);
            }
        }, 5000);
    }

    // Run on initial load and on page navigation (View Transitions)
    initReviewCarousel();
    document.addEventListener("astro:after-swap", initReviewCarousel);
</script>

<style>
    .review-slide {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .review-slide.active {
        display: block;
        opacity: 1;
    }

    .tab-list {
        margin-top: 20px;
        list-style-type: none;
        padding: 0;
    }
</style>
